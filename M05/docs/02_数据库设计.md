# 用户管理系统 - 数据库设计

## 1. 学习目标

通过本文档的学习，学生将掌握：
- 基于RBAC模型的数据库设计方法
- MySQL数据库表结构设计和约束设置
- 索引优化和性能考虑
- 数据库安全性设计
- 完整的用户管理系统数据模型

## 2. 数据库设计概述

### 2.1 技术选型
- **数据库**：MySQL 8.0+
- **字符集**：utf8mb4_unicode_ci（支持完整的UTF-8字符集）
- **存储引擎**：InnoDB（支持事务和外键约束）

### 2.2 设计原则
- **规范化设计**：遵循第三范式，避免数据冗余
- **性能优化**：合理设置索引，优化查询性能
- **扩展性**：预留扩展字段，支持业务发展
- **安全性**：敏感数据加密存储，设置合理的约束
- **完整性**：通过外键约束保证数据完整性

### 2.3 RBAC权限模型
本系统采用基于角色的访问控制（RBAC）模型：
- **用户（User）**：系统的使用者
- **角色（Role）**：权限的集合
- **权限（Permission）**：对资源的操作许可
- **关系**：用户-角色（多对多），角色-权限（多对多）

## 3. 数据库表设计

### 3.1 核心用户表

#### 3.1.1 用户表 (users)
存储用户的基本信息，是系统的核心表。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 用户ID，主键 |
| username | varchar(50) | 是 | - | 用户名，唯一 |
| email | varchar(100) | 是 | - | 邮箱，唯一 |
| phone | varchar(20) | 否 | NULL | 手机号，唯一 |
| password_hash | varchar(255) | 是 | - | 密码哈希值 |
| nickname | varchar(100) | 否 | NULL | 昵称 |
| avatar_url | varchar(500) | 否 | NULL | 头像URL |
| bio | text | 否 | NULL | 个人简介 |
| status | tinyint | 是 | 1 | 账户状态：0-禁用，1-正常，2-锁定 |
| email_verified | tinyint | 是 | 0 | 邮箱是否验证：0-未验证，1-已验证 |
| phone_verified | tinyint | 是 | 0 | 手机是否验证：0-未验证，1-已验证 |
| login_attempts | int | 是 | 0 | 登录失败次数 |
| locked_until | datetime | 否 | NULL | 锁定到期时间 |
| last_login_at | datetime | 否 | NULL | 最后登录时间 |
| last_login_ip | varchar(45) | 否 | NULL | 最后登录IP |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | datetime | 否 | NULL | 删除时间（软删除） |

```sql
CREATE TABLE `users` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希值',
  `nickname` varchar(100) DEFAULT NULL COMMENT '昵称',
  `avatar_url` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `bio` text COMMENT '个人简介',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '账户状态：0-禁用，1-正常，2-锁定',
  `email_verified` tinyint NOT NULL DEFAULT '0' COMMENT '邮箱是否验证：0-未验证，1-已验证',
  `phone_verified` tinyint NOT NULL DEFAULT '0' COMMENT '手机是否验证：0-未验证，1-已验证',
  `login_attempts` int NOT NULL DEFAULT '0' COMMENT '登录失败次数',
  `locked_until` datetime DEFAULT NULL COMMENT '锁定到期时间',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(45) DEFAULT NULL COMMENT '最后登录IP',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_phone` (`phone`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 3.1.2 用户登录日志表 (user_login_logs)

记录用户登录历史，用于安全监控。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 日志ID，主键 |
| user_id | bigint | 是 | - | 用户ID，外键 |
| login_type | varchar(20) | 是 | - | 登录方式：email, username, phone, sms |
| ip_address | varchar(45) | 是 | - | 登录IP地址 |
| user_agent | text | 否 | NULL | 用户代理信息 |
| device_info | varchar(200) | 否 | NULL | 设备信息 |
| location | varchar(100) | 否 | NULL | 登录地点 |
| status | tinyint | 是 | - | 登录状态：0-失败，1-成功 |
| failure_reason | varchar(100) | 否 | NULL | 失败原因 |
| session_id | varchar(100) | 否 | NULL | 会话ID |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 登录时间 |

```sql
CREATE TABLE `user_login_logs` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `login_type` varchar(20) NOT NULL COMMENT '登录方式：email, username, phone, sms',
  `ip_address` varchar(45) NOT NULL COMMENT '登录IP地址',
  `user_agent` text COMMENT '用户代理信息',
  `device_info` varchar(200) DEFAULT NULL COMMENT '设备信息',
  `location` varchar(100) DEFAULT NULL COMMENT '登录地点',
  `status` tinyint NOT NULL COMMENT '登录状态：0-失败，1-成功',
  `failure_reason` varchar(100) DEFAULT NULL COMMENT '失败原因',
  `session_id` varchar(100) DEFAULT NULL COMMENT '会话ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_ip_address` (`ip_address`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_login_logs_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户登录日志表';
```

#### 3.1.3 用户验证码表 (user_verification_codes)

存储邮箱和短信验证码。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 验证码ID，主键 |
| user_id | bigint | 否 | NULL | 用户ID（注册时可能为空） |
| type | varchar(20) | 是 | - | 验证码类型：email_register, email_reset, sms_register, sms_reset, sms_login |
| target | varchar(100) | 是 | - | 目标邮箱或手机号 |
| code | varchar(10) | 是 | - | 验证码 |
| used | tinyint | 是 | 0 | 是否已使用：0-未使用，1-已使用 |
| expires_at | datetime | 是 | - | 过期时间 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE `user_verification_codes` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '验证码ID',
  `user_id` bigint DEFAULT NULL COMMENT '用户ID（注册时可能为空）',
  `type` varchar(20) NOT NULL COMMENT '验证码类型：email_register, email_reset, sms_register, sms_reset, sms_login',
  `target` varchar(100) NOT NULL COMMENT '目标邮箱或手机号',
  `code` varchar(10) NOT NULL COMMENT '验证码',
  `used` tinyint NOT NULL DEFAULT '0' COMMENT '是否已使用：0-未使用，1-已使用',
  `expires_at` datetime NOT NULL COMMENT '过期时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_target_type` (`target`, `type`),
  KEY `idx_code` (`code`),
  KEY `idx_expires_at` (`expires_at`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_verification_codes_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户验证码表';
```

### 3.2 RBAC权限相关表

#### 3.2.1 角色表 (roles)

定义系统中的各种角色。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 角色ID，主键 |
| name | varchar(50) | 是 | - | 角色名称，唯一 |
| code | varchar(50) | 是 | - | 角色编码，唯一 |
| description | text | 否 | NULL | 角色描述 |
| is_system | tinyint | 是 | 0 | 是否系统角色：0-否，1-是（系统角色不可删除） |
| status | tinyint | 是 | 1 | 状态：0-禁用，1-启用 |
| sort_order | int | 是 | 0 | 排序顺序 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | datetime | 否 | NULL | 删除时间（软删除） |

```sql
CREATE TABLE `roles` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `name` varchar(50) NOT NULL COMMENT '角色名称',
  `code` varchar(50) NOT NULL COMMENT '角色编码',
  `description` text COMMENT '角色描述',
  `is_system` tinyint NOT NULL DEFAULT '0' COMMENT '是否系统角色：0-否，1-是（系统角色不可删除）',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '排序顺序',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  UNIQUE KEY `uk_name` (`name`),
  KEY `idx_status` (`status`),
  KEY `idx_sort_order` (`sort_order`),
  KEY `idx_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色表';
```

#### 3.2.2 权限表 (permissions)

定义系统中的各种权限。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 权限ID，主键 |
| name | varchar(100) | 是 | - | 权限名称 |
| code | varchar(100) | 是 | - | 权限编码，唯一 |
| description | text | 否 | NULL | 权限描述 |
| module | varchar(50) | 是 | - | 所属模块 |
| resource | varchar(100) | 否 | NULL | 资源标识 |
| action | varchar(50) | 否 | NULL | 操作类型：create, read, update, delete, execute |
| is_system | tinyint | 是 | 0 | 是否系统权限：0-否，1-是 |
| status | tinyint | 是 | 1 | 状态：0-禁用，1-启用 |
| sort_order | int | 是 | 0 | 排序顺序 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | datetime | 否 | NULL | 删除时间（软删除） |

```sql
CREATE TABLE `permissions` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `name` varchar(100) NOT NULL COMMENT '权限名称',
  `code` varchar(100) NOT NULL COMMENT '权限编码',
  `description` text COMMENT '权限描述',
  `module` varchar(50) NOT NULL COMMENT '所属模块',
  `resource` varchar(100) DEFAULT NULL COMMENT '资源标识',
  `action` varchar(50) DEFAULT NULL COMMENT '操作类型：create, read, update, delete, execute',
  `is_system` tinyint NOT NULL DEFAULT '0' COMMENT '是否系统权限：0-否，1-是',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '排序顺序',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_module` (`module`),
  KEY `idx_resource_action` (`resource`, `action`),
  KEY `idx_status` (`status`),
  KEY `idx_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='权限表';
```

#### 3.2.3 角色权限关联表 (role_permissions)

角色和权限的多对多关联。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 关联ID，主键 |
| role_id | bigint | 是 | - | 角色ID，外键 |
| permission_id | bigint | 是 | - | 权限ID，外键 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE `role_permissions` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `permission_id` bigint NOT NULL COMMENT '权限ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_permission` (`role_id`, `permission_id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_permission_id` (`permission_id`),
  CONSTRAINT `fk_role_permissions_role_id` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_role_permissions_permission_id` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色权限关联表';
```

#### 3.2.4 用户角色关联表 (user_roles)

用户和角色的多对多关联。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 关联ID，主键 |
| user_id | bigint | 是 | - | 用户ID，外键 |
| role_id | bigint | 是 | - | 角色ID，外键 |
| assigned_by | bigint | 否 | NULL | 分配者用户ID |
| assigned_at | datetime | 是 | CURRENT_TIMESTAMP | 分配时间 |
| expires_at | datetime | 否 | NULL | 过期时间（可选） |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE `user_roles` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `assigned_by` bigint DEFAULT NULL COMMENT '分配者用户ID',
  `assigned_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
  `expires_at` datetime DEFAULT NULL COMMENT '过期时间（可选）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_role` (`user_id`, `role_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_assigned_by` (`assigned_by`),
  KEY `idx_expires_at` (`expires_at`),
  CONSTRAINT `fk_user_roles_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_user_roles_role_id` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_user_roles_assigned_by` FOREIGN KEY (`assigned_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户角色关联表';
```

### 3.3 团队管理相关表

#### 3.3.1 团队表 (teams)

存储团队基本信息。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 团队ID，主键 |
| name | varchar(100) | 是 | - | 团队名称，唯一 |
| code | varchar(50) | 否 | NULL | 团队编码，唯一 |
| description | text | 否 | NULL | 团队描述 |
| avatar_url | varchar(500) | 否 | NULL | 团队头像URL |
| visibility | varchar(20) | 是 | 'private' | 可见性：public-公开，private-私有 |
| join_policy | varchar(20) | 是 | 'approval' | 加入策略：open-开放，approval-需审批，invite-仅邀请 |
| max_members | int | 否 | NULL | 最大成员数（null表示无限制） |
| owner_id | bigint | 是 | - | 团队负责人ID，外键 |
| status | tinyint | 是 | 1 | 状态：0-禁用，1-正常，2-已解散 |
| settings | json | 否 | NULL | 团队设置（JSON格式） |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | datetime | 否 | NULL | 删除时间（软删除） |

```sql
CREATE TABLE `teams` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '团队ID',
  `name` varchar(100) NOT NULL COMMENT '团队名称',
  `code` varchar(50) DEFAULT NULL COMMENT '团队编码',
  `description` text COMMENT '团队描述',
  `avatar_url` varchar(500) DEFAULT NULL COMMENT '团队头像URL',
  `visibility` varchar(20) NOT NULL DEFAULT 'private' COMMENT '可见性：public-公开，private-私有',
  `join_policy` varchar(20) NOT NULL DEFAULT 'approval' COMMENT '加入策略：open-开放，approval-需审批，invite-仅邀请',
  `max_members` int DEFAULT NULL COMMENT '最大成员数（null表示无限制）',
  `owner_id` bigint NOT NULL COMMENT '团队负责人ID',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-正常，2-已解散',
  `settings` json DEFAULT NULL COMMENT '团队设置（JSON格式）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_owner_id` (`owner_id`),
  KEY `idx_visibility` (`visibility`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_teams_owner_id` FOREIGN KEY (`owner_id`) REFERENCES `users` (`id`) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='团队表';
```

#### 3.3.2 团队成员表 (team_members)

存储团队成员信息和角色。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 成员ID，主键 |
| team_id | bigint | 是 | - | 团队ID，外键 |
| user_id | bigint | 是 | - | 用户ID，外键 |
| role | varchar(20) | 是 | 'member' | 团队角色：owner-负责人，admin-管理员，member-普通成员 |
| status | tinyint | 是 | 1 | 状态：0-已移除，1-正常 |
| joined_at | datetime | 是 | CURRENT_TIMESTAMP | 加入时间 |
| invited_by | bigint | 否 | NULL | 邀请者ID |
| permissions | json | 否 | NULL | 特殊权限设置（JSON格式） |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `team_members` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '成员ID',
  `team_id` bigint NOT NULL COMMENT '团队ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role` varchar(20) NOT NULL DEFAULT 'member' COMMENT '团队角色：owner-负责人，admin-管理员，member-普通成员',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-已移除，1-正常',
  `joined_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
  `invited_by` bigint DEFAULT NULL COMMENT '邀请者ID',
  `permissions` json DEFAULT NULL COMMENT '特殊权限设置（JSON格式）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_team_user` (`team_id`, `user_id`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`),
  KEY `idx_invited_by` (`invited_by`),
  CONSTRAINT `fk_team_members_team_id` FOREIGN KEY (`team_id`) REFERENCES `teams` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_team_members_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_team_members_invited_by` FOREIGN KEY (`invited_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='团队成员表';
```

#### 3.3.3 团队邀请表 (team_invitations)

存储团队邀请记录。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 邀请ID，主键 |
| team_id | bigint | 是 | - | 团队ID，外键 |
| inviter_id | bigint | 是 | - | 邀请者ID，外键 |
| invitee_email | varchar(100) | 否 | NULL | 被邀请者邮箱 |
| invitee_user_id | bigint | 否 | NULL | 被邀请者用户ID（如果已注册） |
| invitation_code | varchar(100) | 是 | - | 邀请码，唯一 |
| role | varchar(20) | 是 | 'member' | 邀请角色 |
| message | text | 否 | NULL | 邀请消息 |
| status | varchar(20) | 是 | 'pending' | 状态：pending-待处理，accepted-已接受，rejected-已拒绝，expired-已过期 |
| expires_at | datetime | 是 | - | 过期时间 |
| responded_at | datetime | 否 | NULL | 响应时间 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `team_invitations` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '邀请ID',
  `team_id` bigint NOT NULL COMMENT '团队ID',
  `inviter_id` bigint NOT NULL COMMENT '邀请者ID',
  `invitee_email` varchar(100) DEFAULT NULL COMMENT '被邀请者邮箱',
  `invitee_user_id` bigint DEFAULT NULL COMMENT '被邀请者用户ID（如果已注册）',
  `invitation_code` varchar(100) NOT NULL COMMENT '邀请码',
  `role` varchar(20) NOT NULL DEFAULT 'member' COMMENT '邀请角色',
  `message` text COMMENT '邀请消息',
  `status` varchar(20) NOT NULL DEFAULT 'pending' COMMENT '状态：pending-待处理，accepted-已接受，rejected-已拒绝，expired-已过期',
  `expires_at` datetime NOT NULL COMMENT '过期时间',
  `responded_at` datetime DEFAULT NULL COMMENT '响应时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_invitation_code` (`invitation_code`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_inviter_id` (`inviter_id`),
  KEY `idx_invitee_email` (`invitee_email`),
  KEY `idx_invitee_user_id` (`invitee_user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_expires_at` (`expires_at`),
  CONSTRAINT `fk_team_invitations_team_id` FOREIGN KEY (`team_id`) REFERENCES `teams` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_team_invitations_inviter_id` FOREIGN KEY (`inviter_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_team_invitations_invitee_user_id` FOREIGN KEY (`invitee_user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='团队邀请表';
```

#### 3.3.4 团队加入申请表 (team_join_requests)

存储用户主动申请加入团队的记录。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 申请ID，主键 |
| team_id | bigint | 是 | - | 团队ID，外键 |
| user_id | bigint | 是 | - | 申请者ID，外键 |
| message | text | 否 | NULL | 申请消息 |
| status | varchar(20) | 是 | 'pending' | 状态：pending-待审批，approved-已批准，rejected-已拒绝，cancelled-已取消 |
| reviewed_by | bigint | 否 | NULL | 审批者ID |
| reviewed_at | datetime | 否 | NULL | 审批时间 |
| review_message | text | 否 | NULL | 审批意见 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 申请时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `team_join_requests` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '申请ID',
  `team_id` bigint NOT NULL COMMENT '团队ID',
  `user_id` bigint NOT NULL COMMENT '申请者ID',
  `message` text COMMENT '申请消息',
  `status` varchar(20) NOT NULL DEFAULT 'pending' COMMENT '状态：pending-待审批，approved-已批准，rejected-已拒绝，cancelled-已取消',
  `reviewed_by` bigint DEFAULT NULL COMMENT '审批者ID',
  `reviewed_at` datetime DEFAULT NULL COMMENT '审批时间',
  `review_message` text COMMENT '审批意见',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_team_user_pending` (`team_id`, `user_id`, `status`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_reviewed_by` (`reviewed_by`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_team_join_requests_team_id` FOREIGN KEY (`team_id`) REFERENCES `teams` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_team_join_requests_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_team_join_requests_reviewed_by` FOREIGN KEY (`reviewed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='团队加入申请表';
```

### 3.4 系统配置和日志表

#### 3.4.1 系统配置表 (system_configs)

存储系统配置信息。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 配置ID，主键 |
| config_key | varchar(100) | 是 | - | 配置键，唯一 |
| config_value | text | 否 | NULL | 配置值 |
| config_type | varchar(20) | 是 | 'string' | 配置类型：string-字符串，number-数字，boolean-布尔，json-JSON对象 |
| category | varchar(50) | 是 | 'general' | 配置分类：general-通用，security-安全，email-邮件，storage-存储等 |
| description | varchar(500) | 否 | NULL | 配置描述 |
| is_public | tinyint | 是 | 0 | 是否公开：0-私有，1-公开（前端可访问） |
| is_editable | tinyint | 是 | 1 | 是否可编辑：0-不可编辑，1-可编辑 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `system_configs` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `config_key` varchar(100) NOT NULL COMMENT '配置键',
  `config_value` text COMMENT '配置值',
  `description` varchar(255) DEFAULT NULL COMMENT '配置描述',
  `type` varchar(20) NOT NULL DEFAULT 'string' COMMENT '值类型：string, number, boolean, json',
  `is_public` tinyint NOT NULL DEFAULT '0' COMMENT '是否公开：0-否，1-是',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`),
  KEY `idx_is_public` (`is_public`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

#### 3.4.2 操作日志表 (operation_logs)

记录用户重要操作日志。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 日志ID，主键 |
| user_id | bigint | 否 | NULL | 操作用户ID，外键 |
| operation | varchar(100) | 是 | - | 操作类型 |
| resource_type | varchar(50) | 否 | NULL | 资源类型 |
| resource_id | varchar(100) | 否 | NULL | 资源ID |
| description | text | 否 | NULL | 操作描述 |
| ip_address | varchar(45) | 否 | NULL | IP地址 |
| user_agent | text | 否 | NULL | 用户代理 |
| request_data | json | 否 | NULL | 请求数据 |
| response_data | json | 否 | NULL | 响应数据 |
| status | varchar(20) | 是 | - | 操作状态：success, failure, error |
| error_message | text | 否 | NULL | 错误信息 |
| duration | int | 否 | NULL | 操作耗时（毫秒） |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 操作时间 |

```sql
CREATE TABLE `operation_logs` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint DEFAULT NULL COMMENT '操作用户ID',
  `operation` varchar(100) NOT NULL COMMENT '操作类型',
  `resource_type` varchar(50) DEFAULT NULL COMMENT '资源类型',
  `resource_id` varchar(100) DEFAULT NULL COMMENT '资源ID',
  `description` text COMMENT '操作描述',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` text COMMENT '用户代理',
  `request_data` json DEFAULT NULL COMMENT '请求数据',
  `response_data` json DEFAULT NULL COMMENT '响应数据',
  `status` varchar(20) NOT NULL COMMENT '操作状态：success, failure, error',
  `error_message` text COMMENT '错误信息',
  `duration` int DEFAULT NULL COMMENT '操作耗时（毫秒）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_operation` (`operation`),
  KEY `idx_resource` (`resource_type`, `resource_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_operation_logs_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

## 4. 初始化数据

### 4.1 默认角色数据

```sql
INSERT INTO `roles` (`name`, `code`, `description`, `is_system`, `sort_order`) VALUES
('超级管理员', 'super_admin', '系统最高权限管理员，拥有所有权限', 1, 1),
('系统管理员', 'admin', '系统管理员，可管理用户、角色、团队等', 1, 2),
('团队负责人', 'team_owner', '团队创建者和最高管理者', 1, 3),
('团队管理员', 'team_admin', '团队管理员，可管理团队成员', 1, 4),
('普通用户', 'user', '普通注册用户', 1, 5);
```

### 4.2 默认权限数据

```sql
INSERT INTO `permissions` (`name`, `code`, `description`, `module`, `resource`, `action`, `is_system`, `sort_order`) VALUES
-- 用户管理权限
('查看用户列表', 'user:list', '查看系统用户列表', 'user', 'user', 'read', 1, 1),
('创建用户', 'user:create', '创建新用户', 'user', 'user', 'create', 1, 2),
('编辑用户', 'user:update', '编辑用户信息', 'user', 'user', 'update', 1, 3),
('删除用户', 'user:delete', '删除用户', 'user', 'user', 'delete', 1, 4),
('重置用户密码', 'user:reset_password', '重置用户密码', 'user', 'user', 'execute', 1, 5),

-- 角色管理权限
('查看角色列表', 'role:list', '查看角色列表', 'role', 'role', 'read', 1, 10),
('创建角色', 'role:create', '创建新角色', 'role', 'role', 'create', 1, 11),
('编辑角色', 'role:update', '编辑角色信息', 'role', 'role', 'update', 1, 12),
('删除角色', 'role:delete', '删除角色', 'role', 'role', 'delete', 1, 13),
('分配角色权限', 'role:assign_permission', '为角色分配权限', 'role', 'role', 'execute', 1, 14),

-- 权限管理权限
('查看权限列表', 'permission:list', '查看权限列表', 'permission', 'permission', 'read', 1, 20),
('分配用户角色', 'user:assign_role', '为用户分配角色', 'user', 'user', 'execute', 1, 21),

-- 团队管理权限
('查看团队列表', 'team:list', '查看团队列表', 'team', 'team', 'read', 1, 30),
('创建团队', 'team:create', '创建新团队', 'team', 'team', 'create', 1, 31),
('编辑团队', 'team:update', '编辑团队信息', 'team', 'team', 'update', 1, 32),
('删除团队', 'team:delete', '删除团队', 'team', 'team', 'delete', 1, 33),
('管理团队成员', 'team:manage_member', '管理团队成员', 'team', 'team_member', 'execute', 1, 34),
('邀请团队成员', 'team:invite', '邀请用户加入团队', 'team', 'team_invitation', 'create', 1, 35),
('审批加入申请', 'team:approve_request', '审批团队加入申请', 'team', 'team_request', 'execute', 1, 36),

-- 系统管理权限
('查看系统配置', 'system:config:read', '查看系统配置', 'system', 'config', 'read', 1, 40),
('修改系统配置', 'system:config:write', '修改系统配置', 'system', 'config', 'update', 1, 41),
('查看操作日志', 'system:log:read', '查看系统操作日志', 'system', 'log', 'read', 1, 42),
('查看登录日志', 'system:login_log:read', '查看用户登录日志', 'system', 'login_log', 'read', 1, 43);
```

### 4.3 默认角色权限分配

```sql
-- 超级管理员拥有所有权限
INSERT INTO `role_permissions` (`role_id`, `permission_id`)
SELECT r.id, p.id FROM `roles` r, `permissions` p WHERE r.code = 'super_admin';

-- 系统管理员权限
INSERT INTO `role_permissions` (`role_id`, `permission_id`)
SELECT r.id, p.id FROM `roles` r, `permissions` p 
WHERE r.code = 'admin' AND p.code IN (
  'user:list', 'user:create', 'user:update', 'user:reset_password',
  'role:list', 'role:create', 'role:update', 'role:assign_permission',
  'permission:list', 'user:assign_role',
  'team:list', 'team:update', 'team:delete', 'team:manage_member',
  'system:config:read', 'system:log:read', 'system:login_log:read'
);

-- 团队负责人权限
INSERT INTO `role_permissions` (`role_id`, `permission_id`)
SELECT r.id, p.id FROM `roles` r, `permissions` p 
WHERE r.code = 'team_owner' AND p.code IN (
  'team:create', 'team:update', 'team:delete', 'team:manage_member',
  'team:invite', 'team:approve_request'
);

-- 团队管理员权限
INSERT INTO `role_permissions` (`role_id`, `permission_id`)
SELECT r.id, p.id FROM `roles` r, `permissions` p 
WHERE r.code = 'team_admin' AND p.code IN (
  'team:update', 'team:manage_member', 'team:invite', 'team:approve_request'
);

-- 普通用户权限
INSERT INTO `role_permissions` (`role_id`, `permission_id`)
SELECT r.id, p.id FROM `roles` r, `permissions` p 
WHERE r.code = 'user' AND p.code IN ('team:create');
```

### 4.4 系统配置初始化

```sql
INSERT INTO `system_configs` (`config_key`, `config_value`, `description`, `type`, `is_public`) VALUES
('site_name', '用户管理系统', '网站名称', 'string', 1),
('site_description', '基于RBAC的用户管理系统', '网站描述', 'string', 1),
('user_register_enabled', 'true', '是否允许用户注册', 'boolean', 1),
('email_verification_required', 'true', '注册时是否需要邮箱验证', 'boolean', 0),
('login_max_attempts', '5', '登录最大失败次数', 'number', 0),
('login_lock_duration', '30', '登录锁定时长（分钟）', 'number', 0),
('verification_code_expires', '5', '验证码有效期（分钟）', 'number', 0),
('invitation_expires_days', '7', '邀请链接有效期（天）', 'number', 0),
('max_teams_per_user', '10', '每个用户最大创建团队数', 'number', 0),
('default_team_max_members', '50', '团队默认最大成员数', 'number', 0);
```

## 5. 索引优化建议

### 5.1 查询优化索引

```sql
-- 用户表额外索引
ALTER TABLE `users` ADD INDEX `idx_email_status` (`email`, `status`);
ALTER TABLE `users` ADD INDEX `idx_phone_status` (`phone`, `status`);

-- 团队成员表复合索引
ALTER TABLE `team_members` ADD INDEX `idx_team_role_status` (`team_id`, `role`, `status`);

-- 操作日志表分区索引（按月分区）
ALTER TABLE `operation_logs` ADD INDEX `idx_user_operation_time` (`user_id`, `operation`, `created_at`);

-- 登录日志表时间索引
ALTER TABLE `user_login_logs` ADD INDEX `idx_user_time` (`user_id`, `created_at`);
```

### 5.2 性能优化建议

1. **分区策略**: 对于日志表可以按时间分区，提高查询性能
2. **读写分离**: 对于查询频繁的表可以考虑读写分离
3. **缓存策略**: 权限信息、角色信息等可以使用Redis缓存
4. **归档策略**: 定期归档历史日志数据

## 6. 数据库关系图

```
用户表 (users)
├── 1:N → 用户登录日志表 (user_login_logs)
├── 1:N → 用户验证码表 (user_verification_codes)
├── N:M → 角色表 (roles) [通过 user_roles]
├── 1:N → 团队表 (teams) [作为owner]
├── N:M → 团队表 (teams) [通过 team_members]
├── 1:N → 团队邀请表 (team_invitations) [作为inviter]
├── 1:N → 团队邀请表 (team_invitations) [作为invitee]
├── 1:N → 团队加入申请表 (team_join_requests)
└── 1:N → 操作日志表 (operation_logs)

角色表 (roles)
├── N:M → 权限表 (permissions) [通过 role_permissions]
└── N:M → 用户表 (users) [通过 user_roles]

团队表 (teams)
├── 1:N → 团队成员表 (team_members)
├── 1:N → 团队邀请表 (team_invitations)
└── 1:N → 团队加入申请表 (team_join_requests)
```
