# DevOps用户管理系统 - 实现指南

## 🗄️ 数据库设计

### 核心表结构

| 表名 | 中文名 | 主要字段 | 说明 |
|------|--------|----------|------|
| `users` | 用户表 | id, username, email, password_hash, status | 存储用户基本信息和认证数据 |
| `roles` | 角色表 | id, name, code, description, is_system | 定义系统角色，支持层级管理 |
| `permissions` | 权限表 | id, name, code, module, resource, action | 细粒度权限控制，按模块分类 |
| `user_roles` | 用户角色关联表 | user_id, role_id, assigned_by | 多对多关系，支持角色分配 |
| `role_permissions` | 角色权限关联表 | role_id, permission_id | 角色与权限的多对多关系 |
| `teams` | 团队表 | id, name, owner_id, visibility, status | 团队管理，支持公开/私有 |
| `team_members` | 团队成员表 | team_id, user_id, role, status | 团队成员关系和角色 |
| `user_login_logs` | 登录日志表 | user_id, ip_address, status, login_time | 记录用户登录行为 |
| `operation_logs` | 操作日志表 | user_id, operation, resource_type, status | 系统操作审计日志 |

### 权限模型设计

```
用户(User) ←→ 角色(Role) ←→ 权限(Permission)
     ↓              ↓              ↓
  团队成员        系统角色        模块权限
(Team Member)   (System Role)   (Module Permission)
```

**权限命名规范**：`模块:操作`
- 用户管理：`user:list`, `user:create`, `user:update`, `user:delete`
- 角色管理：`role:list`, `role:create`, `role:assign_permission`
- 团队管理：`team:create`, `team:manage_member`, `team:invite`

## 🗂️ 实现路线图

```
第一阶段：环境搭建 → 第二阶段：基础功能 → 第三阶段：权限系统 → 第四阶段：完善测试
    ↓                    ↓                    ↓                    ↓
环境准备              用户注册登录           角色权限管理          API测试
项目初始化            JWT认证               RBAC实现             部署上线
数据库配置            安全配置              权限验证             性能优化
```

## 第一阶段：环境搭建

### 步骤1：开发环境准备

**必需软件**：
- ✅ **JDK 17+**：Java开发环境
- ✅ **Maven 3.9+**：项目构建工具  
- ✅ **MySQL 8.0+**：数据库服务器
- ✅ **IntelliJ IDEA**：集成开发环境

### 步骤2：创建Spring Boot项目

**使用Spring Initializr创建项目**：
1. 访问 https://start.spring.io/
2. 配置项目参数：Maven + Java 17 + Spring Boot 3.2.1
3. 添加依赖：Spring Web、Spring Security、MySQL Driver、MyBatis Framework
4. 生成并下载项目

### 步骤3：项目结构规划

**标准分层架构**：
```
src/main/java/com/example/demo/
├── auth/                           # 认证模块
├── user/                           # 用户管理模块
│   ├── controller/                 # 控制器层
│   ├── entity/                     # 实体类
│   ├── mapper/                     # 数据访问层
│   ├── service/                    # 业务逻辑层
│   └── dto/                        # 数据传输对象
├── role/                           # 角色管理模块
├── security/                       # 安全组件
├── common/                         # 公共组件
└── config/                         # 配置类
```

### 步骤4：配置数据库连接

**配置要点**：
- 数据库连接信息：地址、端口、用户名、密码
- MyBatis配置：Mapper文件位置、实体类包路径
- JWT配置：密钥、过期时间
- 日志配置：调试级别设置

### 步骤5：添加项目依赖

**核心依赖包**：
- Spring Boot Web Starter：Web应用基础
- Spring Security：安全框架
- MyBatis：数据访问框架
- MySQL Driver：数据库驱动
- JWT：身份认证令牌
- Validation：数据验证
- Lombok：代码简化

## 第二阶段：基础功能实现

### 步骤1：统一响应格式设计

**响应结构**：
- code：状态码（200成功，400客户端错误，500服务器错误）
- message：响应消息
- data：响应数据
- timestamp：时间戳

### 步骤2：全局异常处理

**异常处理策略**：
- 业务异常：自定义异常类，返回具体错误信息
- 系统异常：统一处理，避免敏感信息泄露
- 参数验证异常：返回具体的字段验证错误

### 步骤3：跨域配置

**CORS配置要点**：
- 允许的源地址
- 允许的HTTP方法
- 允许的请求头
- 是否允许携带凭证

## 第三阶段：数据库配置

### 步骤1：数据库初始化

**初始化内容**：
- 创建数据库和表结构
- 插入基础数据（角色、权限）
- 创建索引优化查询性能
- 设置数据库连接池

### 步骤2：MyBatis配置

**配置要点**：
- Mapper接口扫描
- XML映射文件位置
- 驼峰命名转换
- 分页插件配置

## 第四阶段：数据访问层实现

### 步骤1：实体类设计

**设计原则**：
- 使用JPA注解标注表映射关系
- 实现序列化接口
- 添加数据验证注解
- 使用Lombok简化代码

### 步骤2：Mapper接口设计

**接口设计**：
- 基础CRUD操作
- 复杂查询方法
- 分页查询支持
- 批量操作方法

### 步骤3：SQL映射文件

**XML配置要点**：
- ResultMap结果映射
- 动态SQL语句
- 参数映射
- 关联查询配置

## 第五阶段：业务逻辑层实现

### 步骤1：用户服务实现

**核心功能**：
- 用户注册：密码加密、邮箱验证、重复检查
- 用户登录：身份验证、JWT生成、登录日志
- 用户管理：增删改查、状态管理、角色分配
- 密码管理：修改密码、重置密码

### 步骤2：角色权限服务

**核心功能**：
- 角色管理：创建角色、分配权限、角色继承
- 权限管理：权限定义、权限检查、权限缓存
- 用户权限：获取用户权限、权限验证

### 步骤3：团队管理服务

**核心功能**：
- 团队创建：团队信息、可见性设置
- 成员管理：邀请成员、移除成员、角色分配
- 权限控制：团队数据权限、操作权限

## 第六阶段：安全配置

### 步骤1：Spring Security配置

**安全配置要点**：
- 密码编码器配置
- 认证管理器配置
- 权限访问控制
- 会话管理策略

### 步骤2：JWT认证实现

**JWT处理流程**：
- 登录成功生成JWT令牌
- 请求携带JWT令牌
- 过滤器验证JWT有效性
- 解析用户信息和权限

### 步骤3：权限控制注解

**注解使用**：
- @PreAuthorize：方法执行前权限检查
- @PostAuthorize：方法执行后权限检查
- @Secured：简单角色检查
- @RolesAllowed：JSR-250标准注解

## 第七阶段：控制器层实现

### 步骤1：认证控制器

**接口功能**：
- 用户注册接口
- 用户登录接口
- 令牌刷新接口
- 用户登出接口

### 步骤2：用户管理控制器

**接口功能**：
- 用户列表查询（支持分页、搜索、排序）
- 用户详情查询
- 用户信息更新
- 用户状态管理
- 用户角色分配

### 步骤3：角色权限控制器

**接口功能**：
- 角色列表管理
- 权限列表管理
- 角色权限分配
- 用户权限查询


## 🔧 常见问题解决

### 1. 数据库连接问题
- 检查数据库服务是否启动
- 验证连接参数是否正确
- 确认网络连通性
- 检查数据库用户权限

### 2. JWT认证问题
- 验证JWT密钥配置
- 检查令牌过期时间
- 确认请求头格式正确
- 验证令牌签名算法

### 3. 权限控制问题
- 检查用户角色分配
- 验证权限配置正确性
- 确认权限注解使用
- 检查权限继承关系

### 4. 性能问题
- 分析慢查询日志
- 检查索引使用情况
- 优化数据库连接池
- 调整JVM参数

## 📚 学习建议

### 1. 循序渐进
- 先理解整体架构设计
- 逐步实现各个功能模块
- 重视测试验证环节
- 关注代码质量和规范

### 2. 实践为主
- 动手编写每一行代码
- 理解每个配置的作用
- 调试解决遇到的问题
- 总结经验和最佳实践
